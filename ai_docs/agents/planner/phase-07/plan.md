# Phase 7 Implementation Plan: Launch Polish & Reliability

## Scope

### What WILL Change
- **Observability**: Add lightweight health/status endpoints and structured logging  
- **User Profiles**: Add profile settings API and basic user preferences  
- **Generation History**: Add comprehensive history API with filtering by mode/room/style  
- **Dashboard UX**: Improve navigation, loading states, empty states, and error boundaries  
- **SEO & Performance**: Add canonical URLs, OG tags, image optimization, and loading improvements  
- **Analytics**: Simple first-party event tracking for basic usage metrics  

### What Will NOT Change
- Existing API endpoints (remain backward compatible)
- Core generation flow (only add logging)
- Authentication system (already complete)
- Billing system (already complete)
- Community features (already complete)

## API Endpoints

### New Health & Status
```typescript
GET /api/v1/health
// Returns: { ok: true, time: string, versions: { next: string } }

GET /api/v1/status  
// Returns: { supabase: 'ok' | 'error' }

POST /api/v1/analytics/event
// Body: { type: 'page' | 'generation_submit' | 'generation_done' | 'error', payload?: any }
// Returns: { success: true }
```

### Profile Settings
```typescript
GET /api/v1/profile/settings
// Returns: { success: true, data: { name?: string, preferences?: object } }

PATCH /api/v1/profile/settings  
// Body: { name?: string, preferences?: object }
// Returns: { success: true, data: UpdatedProfile }
```

### Generation History  
```typescript
GET /api/v1/generations/history
// Query: ?cursor=&limit=&mode=&roomType=&style=&status=
// Returns: { success: true, data: { items: GenerationJob[], nextCursor?: string } }
```

## Services & Repositories

### New Services
- **libs/services/observability.ts**: Health checks and analytics helpers
- **libs/services/profile.ts**: User profile settings management  

### Modified Services
- **libs/services/generations.ts**: Add structured logging throughout lifecycle
- **libs/services/replicate.ts**: Add request/response logging with sanitization

### New Repositories
- **libs/repositories/analytics.ts**: Simple analytics data persistence

### Modified Repositories  
- **libs/repositories/profiles.ts**: Add profile settings fields (name, preferences)
- **libs/repositories/generations.ts**: Add history query with comprehensive filtering

## Migrations

### Migration Files
- **migrations/phase7/011_logs_analytics.sql**: Analytics events table
- **migrations/phase7/012_profile_enhancements.sql**: Add name, preferences to profiles

```sql
-- 011_logs_analytics.sql
create table if not exists public.logs_analytics (
  id bigint generated by default as identity primary key,
  owner_id uuid,
  type text not null,
  payload jsonb,
  created_at timestamptz default now()
);
alter table public.logs_analytics enable row level security;

-- 012_profile_enhancements.sql  
alter table public.profiles add column if not exists name text;
alter table public.profiles add column if not exists preferences jsonb default '{}'::jsonb;
```

## UI Surfaces & Components

### New Pages
- **app/(app)/dashboard/profile/page.tsx**: User profile settings form
- **app/(app)/dashboard/history/page.tsx**: Generation history with filters

### Enhanced Existing Pages  
- **app/(app)/dashboard/page.tsx**: Better navigation, empty states, loading skeletons
- **app/(app)/dashboard/generate/page.tsx**: Error boundary, improved loading states

### New Components
- **components/ui/skeleton.tsx**: Loading skeleton component
- **components/ProfileSettingsForm.tsx**: Profile editing form  
- **components/GenerationHistoryFilter.tsx**: History filtering controls
- **components/ErrorBoundary.tsx**: React error boundary wrapper

### Enhanced Components
- **components/LayoutClient.tsx**: Add error boundary wrapper
- Navigation improvements across dashboard layouts

## External Service Usage

### Analytics (First-Party)
- **Pattern**: Fire-and-forget POST to /api/v1/analytics/event  
- **Events**: page views, generation_submit, generation_done, errors
- **Storage**: Simple logs_analytics table, no external vendors
- **Privacy**: User-scoped or anonymous, no PII tracking

### No Replicate/OpenAI Changes
- Generation flow remains unchanged  
- Only add logging around existing calls
- Log sanitized request/response metadata (no secrets, no full payloads)

## Acceptance Criteria

### Observability
- [ ] GET /api/v1/health returns 200 with expected JSON shape
- [ ] GET /api/v1/status checks Supabase connectivity  
- [ ] Generation flow logs key events to stdout in JSON format
- [ ] Analytics endpoint accepts events and stores in database

### User Experience  
- [ ] Profile settings page allows name/preferences editing
- [ ] Generation history shows filterable list of past jobs
- [ ] Dashboard shows loading skeletons instead of blank states
- [ ] Error boundary catches and displays user-friendly error messages  
- [ ] Empty states have clear call-to-action messaging

### Performance & SEO
- [ ] All images use next/image with proper width/height (prevent CLS)  
- [ ] Canonical URLs set on all public pages
- [ ] OG tags populated via existing SEO helper
- [ ] Loading states prevent layout shifts
- [ ] Page load times remain under existing benchmarks

### Code Quality
- [ ] `npm run build` passes without errors
- [ ] All grep checks from handbook return 0 forbidden matches
- [ ] API responses follow normalized JSON structure
- [ ] No Server Actions introduced
- [ ] All new routes follow Route → Service → Repository pattern

### Backward Compatibility  
- [ ] All existing API endpoints continue to work unchanged
- [ ] Legacy Stripe routes still functional  
- [ ] Dashboard navigation preserves existing functionality
- [ ] Community features remain fully operational

---

**HANDOFF**: spec-executor  
**ARTIFACTS**:
- /Users/varunprasad/Desktop/Interior/ai_docs/agents/planner/phase-07/plan.md
- /Users/varunprasad/Desktop/Interior/ai_docs/agents/planner/phase-07/change_spec.md