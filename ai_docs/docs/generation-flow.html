<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interior AI — End‑to‑End Generation Flow (Docs)</title>
    <style>
      :root {
        --bg: #0b0e14;
        --panel: #0f1320;
        --ink: #e6edf3;
        --muted: #9fb0c1;
        --primary: #47B3FF;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
        --border: #1c2333;
        --node: #101829;
        --accent: #101522;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0; padding: 28px; font: 15px/1.55 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color: var(--ink); background: linear-gradient(180deg, #0b0e14, #0c111a);
      }
      a { color: var(--primary); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .wrap { max-width: 1200px; margin: 0 auto; }
      header { margin-bottom: 18px; }
      h1 { font-size: 30px; margin: 0 0 8px; }
      h2 { font-size: 18px; margin: 18px 0 8px; }
      h3 { font-size: 14px; margin: 12px 0 6px; color: var(--muted); letter-spacing: .02em; text-transform: uppercase; }
      p.lead { color: var(--muted); margin: 0 0 18px; }
      .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
      .grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 16px; }
      @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

      .legend { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; color: var(--muted); }
      .legend span { display: inline-flex; align-items: center; gap: 6px; }
      .tag { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }
      .t-ui { background: #32405a; }
      .t-api { background: #3b82f6; }
      .t-svc { background: #22c55e; }
      .t-prov { background: #0ea5e9; }
      .t-ext { background: #f59e0b; }
      .t-storage { background: #14b8a6; }
      .t-db { background: #ef4444; }

      .flow { background: var(--accent); border: 1px solid var(--border); border-radius: 14px; padding: 16px; overflow-x: auto; }
      .rail { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(240px, 1fr); gap: 12px; align-items: stretch; }
      .node { background: var(--node); border: 1px solid var(--border); border-radius: 12px; padding: 12px; min-height: 120px; display: flex; flex-direction: column; gap: 6px; }
      .node .title { font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: .02em; }
      .node .path { font-size: 12px; color: #c7d2fe; }
      .node .desc { font-size: 12px; color: var(--muted); }
      .arrow { align-self: center; color: var(--muted); font-size: 20px; }

      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      code { background: #0f1522; border: 1px solid var(--border); padding: 2px 6px; border-radius: 8px; color: #c7e1ff; }
      pre { background: #0f1522; border: 1px solid var(--border); padding: 12px; border-radius: 12px; overflow: auto; }
      ul { margin: 8px 0 0 18px; }
      li { margin: 4px 0; }
      .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      @media (max-width: 980px) { .cols { grid-template-columns: 1fr; } }
      .status { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; }
      .ok { color: var(--ok); border-color: #1d3f2a; background: #0c1911; }
      .warn { color: var(--warn); border-color: #3e2d0a; background: #171207; }
      .err { color: var(--err); border-color: #441515; background: #160a0a; }
      .note { color: var(--muted); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Interior AI — End‑to‑End Generation Flow</h1>
        <p class="lead">Visual + descriptive overview of the full generation pipeline: UI → API → Service → Provider → Replicate → Webhook → Storage/DB → back to UI. Includes idempotency, concurrency, and observability.</p>
      </header>

      <section class="flow">
        <div class="legend">
          <span><i class="tag t-ui"></i> UI</span>
          <span><i class="tag t-api"></i> API Route</span>
          <span><i class="tag t-svc"></i> Service</span>
          <span><i class="tag t-prov"></i> Provider</span>
          <span><i class="tag t-ext"></i> Replicate</span>
          <span><i class="tag t-storage"></i> Storage</span>
          <span><i class="tag t-db"></i> Database</span>
        </div>
        <div class="rail">
          <div class="node">
            <div class="title">UI</div>
            <div class="path">/dashboard/create</div>
            <div class="desc">User selects mode/presets, uploads images, enters prompt. Client submits multipart with an idempotency UUID.</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <div class="title">API Route</div>
            <div class="path">app/api/v1/generations/route.ts</div>
            <div class="desc">Validate (Zod), auth, assemble submission and pass to service with derived base URL (for webhooks).</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <div class="title">Service</div>
            <div class="path">libs/services/generation.ts</div>
            <div class="desc">Enforce one in‑flight job per user, plan quota, moderation. Upload inputs to private bucket; create <code>generation_jobs</code> row (status <span class="status warn">starting</span>) to acquire DB lock.</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <div class="title">Provider</div>
            <div class="path">ReplicateProvider</div>
            <div class="desc">Map inputs for Replicate; call <code>predictions.create</code> with <code>Idempotency-Key</code> header and webhook events (start/output/logs/completed).</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <div class="title">Replicate</div>
            <div class="path">predictions</div>
            <div class="desc">Schedules/runs the job; sends webhook events to our endpoint signed via HMAC.</div>
          </div>
          <div class="arrow">⟲</div>
          <div class="node">
            <div class="title">Webhook</div>
            <div class="path">/api/v1/webhooks/replicate</div>
            <div class="desc">Verify signature; download outputs (retry+timeout), store to <code>public/renders/&lt;renderId&gt;/&lt;idx&gt;.webp</code>, insert <code>renders</code> + <code>render_variants</code>, mark job terminal.</div>
          </div>
          <div class="arrow">⟲</div>
          <div class="node">
            <div class="title">UI Poll</div>
            <div class="path">GET /api/v1/generations/:id</div>
            <div class="desc">Returns status and variant URLs when succeeded. Server may fetch Replicate once (throttled) if stale.</div>
          </div>
        </div>
      </section>

      <div class="grid" style="margin-top:16px;">
        <section class="panel">
          <h2>Step‑By‑Step</h2>
          <ol>
            <li><b>Submit</b>: multipart fields include <code>mode</code>, <code>prompt</code>, presets, <code>settings</code>, <code>variants</code>, <code>input1/2</code>, and <code>idempotencyKey</code>.</li>
            <li><b>Route</b>: Zod validation, auth; build a clean submission object.</li>
            <li><b>Service</b>:
              <ul>
                <li>One in‑flight per user (DB partial unique on <code>(owner_id)</code> with status in starting/processing).</li>
                <li>Quota: monthly cap via <code>usage_ledger</code> and <code>runtimeConfig.plans</code>.</li>
                <li>Moderation: lightweight checks on prompt/images.</li>
                <li>Uploads: inputs saved to <code>private/&lt;uid&gt;/inputs/&lt;uuid&gt;</code> and signed for provider.</li>
              </ul>
            </li>
            <li><b>Provider</b>: create prediction with upstream <code>Idempotency-Key</code>; record <code>prediction_id</code> in <code>generation_jobs</code>.</li>
            <li><b>Webhook</b>: signed payload; download, store, insert <code>renders</code>/<code>render_variants</code>; mark job succeeded/failed.</li>
            <li><b>UI</b>: poll <code>GET /api/v1/generations/:id</code> until terminal; render variants with save/download actions.</li>
          </ol>
        </section>

        <section class="panel">
          <h2>Idempotency & Concurrency</h2>
          <ul>
            <li>Client sends a unique <code>idempotencyKey</code>; server guarantees one exists.</li>
            <li>Upstream receives the same key via <code>Idempotency-Key</code> to dedupe retries.</li>
            <li>DB partial unique index guarantees one in‑flight job per user.</li>
          </ul>
          <h2>Status Timeline</h2>
          <ul>
            <li>starting → processing → <span class="status ok">succeeded</span> | <span class="status err">failed</span> | <span class="status warn">canceled</span></li>
            <li>Server stale polling is throttled and secondary to webhook.</li>
          </ul>
        </section>
      </div>

      <section class="panel" style="margin-top:16px;">
        <h2>Data & Storage</h2>
        <div class="cols">
<div>
  <h3>Tables</h3>
  <ul>
    <li><code>generation_jobs</code> — job state, prediction_id, owner, inputs.</li>
    <li><code>renders</code> — one per job, with style/mode metadata.</li>
    <li><code>render_variants</code> — indexed outputs per render (image_path).</li>
    <li><code>usage_ledger</code> — debits/credits for monthly caps.</li>
  </ul>
  <h3>Storage Paths</h3>
  <ul>
    <li>Inputs → <code>private/&lt;uid&gt;/inputs/&lt;uuid&gt;.&lt;ext&gt;</code></li>
    <li>Outputs → <code>public/renders/&lt;renderId&gt;/&lt;idx&gt;.webp</code></li>
  </ul>
</div>
<div>
  <h3>Resilience</h3>
  <ul>
    <li>Downloads retried with timeout; uploads retried; duplicate uploads OK.</li>
    <li>Webhook idempotent: reuse render by job; skip existing variants.</li>
    <li>Only error if zero assets processed and no existing variants.</li>
  </ul>
  <h3>Errors & Retries</h3>
  <ul>
    <li>Upstream create retries on 429/5xx; upstream dedupe prevents duplicates.</li>
    <li>Webhook always returns 2xx (log+alert) to prevent retry storms.</li>
  </ul>
</div>
        </div>
      </section>

      <section class="panel" style="margin-top:16px;">
        <h2>Observability</h2>
        <p class="note">Structured JSON logging with <code>event</code> and <code>fields</code>.</p>
        <ul>
          <li><code>generation_submit</code>, <code>generation_submit_failed</code>, <code>generation_debit</code></li>
          <li><code>generation_inflight_block</code>, <code>generation_inflight_db_block</code>, <code>generation_idempotent_returned</code></li>
          <li><code>generation_poll_update</code>, <code>generation_poll_error</code></li>
          <li><code>webhook_received</code>, <code>webhook_processed</code> (with <code>durationMs</code>), <code>webhook_failed</code></li>
        </ul>
        <pre>{ "ts": "2025-09-07T12:00:00Z", "level": "info", "event": "webhook_processed", "fields": { "jobId": "...", "predictionId": "...", "outputs": 2, "durationMs": 74321 } }</pre>
      </section>

      <section class="panel" style="margin-top:16px;">
        <h2>Developer Map</h2>
        <ul>
          <li>API: <code>app/api/v1/generations/route.ts</code>, <code>app/api/v1/generations/[id]/route.ts</code>, <code>app/api/v1/webhooks/replicate/route.ts</code></li>
          <li>Service: <code>libs/services/generation.ts</code>, <code>libs/services/generation_webhooks.ts</code></li>
          <li>Provider: <code>libs/services/providers/replicateProvider.ts</code>, <code>generationProvider.ts</code></li>
          <li>Adapter/Client: <code>libs/services/external/replicateAdapter.ts</code>, <code>replicateClient.ts</code></li>
          <li>Repositories: <code>libs/repositories/generation_jobs.ts</code>, <code>renders.ts</code>, <code>usage.ts</code></li>
          <li>Storage: <code>libs/services/storage/uploads.ts</code>, <code>storage/assets.ts</code></li>
          <li>Docs: <code>ai_docs/plans/*</code> (provider integration, idempotency, observability, plan)</li>
        </ul>
      </section>

      <section class="panel" style="margin-top:16px;">
        <h2>Checklist</h2>
        <ul>
          <li>Apply migration <code>011_generation_jobs_owner_inflight_unique.sql</code></li>
          <li>ENV: <code>OPENAI_API_KEY</code>, <code>REPLICATE_API_TOKEN</code>, <code>REPLICATE_WEBHOOK_SECRET</code>, <code>NEXT_PUBLIC_APP_URL</code></li>
          <li>Confirm Replicate webhooks reach <code>/api/v1/webhooks/replicate</code> (prod URL)</li>
          <li>Run a manual submit → webhook → renders smoke</li>
        </ul>
      </section>
    </div>
  </body>
  </html>

