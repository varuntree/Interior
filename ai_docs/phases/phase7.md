PHASE_07__reliability-observability-and-launch-polish.md
1) Title & Goal
Reliability & Launch Polish (Minimal): add light observability, user‑visible status, and small performance/UX touches to be “launch ready” without adding heavy infra.

2) Scope (In/Out)
In (small, high‑impact)

Health & status endpoints for quick checks.

Structured logs for generation lifecycle.

Tiny analytics hook (page views + generation events) using a pass‑through endpoint (no external vendor).

UX polish: skeletons, toasts consistency, empty states, copy tweaks.

SEO polish: canonical URLs, OG tags confirm, sitemap inclusion for Community.

Image delivery: ensure <img>/next/image usage where appropriate; avoid layout shift.

Out

Centralized logging platform, tracing, metrics backend.

Rate limiting / WAF.

Background queueing/webhooks (already consciously postponed).

3) Spec References
specs/06-testing-and-quality.md — smoke checks.

docs/01-handbook.md — rendering policy, API standards, guardrails.

specs/04-ui-ux.md — loading states & microcopy patterns.

4) Planned Changes (by layer)
4.1 Observability (lightweight)
libs/observability/logger.ts

ts
Copy
export const log = {
  info: (msg: string, meta?: any) => console.info(JSON.stringify({ lvl:'info', msg, ...meta })),
  warn: (msg: string, meta?: any) => console.warn(JSON.stringify({ lvl:'warn', msg, ...meta })),
  err:  (msg: string, meta?: any) => console.error(JSON.stringify({ lvl:'error', msg, ...meta })),
}
Use in services: generations (submit, poll success/failure), replicate (request/response ids).

Never log secrets or full request bodies.

app/api/v1/health/route.ts (GET)

Returns { ok: true, time, versions: { next: <ver> } }.

No upstream checks (kept trivial).

app/api/v1/status/route.ts (GET)

Tries a fast read:

select 1 against Supabase (profiles self read or ping via client).

Returns { supabase: 'ok'|'error' }.

Used by an internal dashboard card (optional).

4.2 Minimal analytics (opt‑in, first‑party only)
app/api/v1/analytics/event/route.ts (POST)

Body: { type: 'page'|'generation_submit'|'generation_done'|'error', payload?: any }

Simply append to a logs_analytics table (tiny).

migrations/phase7/011_logs_analytics.sql

sql
Copy
create table if not exists public.logs_analytics (
  id bigint generated by default as identity primary key,
  owner_id uuid,                 -- nullable for page views
  type text not null,
  payload jsonb,
  created_at timestamptz default now()
);
alter table public.logs_analytics enable row level security;

-- Anyone can insert their own events (or null owner); nobody can select (we'll query admin‑only later if needed)
create policy "analytics_insert" on public.logs_analytics for insert
  with check (auth.uid() = owner_id or owner_id is null);
create policy "analytics_no_select" on public.logs_analytics for select
  using (false);
This keeps analytics ultra‑simple and private. We can inspect via SQL if needed; no dashboards now.

4.3 UI polish
Loading and skeletons

Ensure generate page shows a skeleton grid while waiting.

Replace generic spinners with consistent skeleton components.

Toasts & copy

Success: “Your render is ready.”

In‑flight: “Please wait until the current generation completes.”

Credit cap: friendly upgrade prompt (Phase 5).

Empty states

Favorites, Collections, Community: focused calls to action.

Images

Use next/image for community/favorites grids when possible; set width/height to avoid CLS.

4.4 SEO tidy‑ups
Confirm canonical on core pages using getSEOTags({ canonicalUrlRelative: '/community' }) for community.

Confirm next-sitemap picks /community and nested pages (no changes needed unless you want to exclude anything).

Ensure OG tags populated via existing SEO helper.

4.5 Small performance wins
Add loading="lazy" where not using next/image.

Avoid large inline JSON in pages; fetch only what’s needed.

Keep Cache-Control: private, no-store on APIs (as per standard).

5) Constraints & Guardrails
No Server Actions, no direct DB from components.

Do not modify guardrail files listed in Handbook §0 beyond allowed additions.

Analytics is best‑effort; failures must not block UI (fire‑and‑forget POST).

6) Acceptance Criteria
/api/v1/health returns ok.

/api/v1/status returns Supabase status (ok for healthy).

Generation flow logs key points (submit, polling start, success/failure) to stdout JSON.

Optional analytics endpoint accepts events; table fills.

Community and Favorites pages feel polished (skeletons, stable cards, good copy).

Build + greps green.

7) Artifacts
ai_docs/changes/PHASE_07__change_spec.md

ai_docs/reports/PHASE_07__qa-report.md