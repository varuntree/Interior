<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interior AI — Generation Flow Map</title>
    <style>
      :root {
        --bg: #0b0c0e;
        --panel: #0f1115;
        --ink: #e8eef6;
        --muted: #a6b0bf;
        --primary: #47B3FF;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
        --border: #273043;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0; padding: 24px; font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color: var(--ink); background: linear-gradient(180deg, #0b0c0e, #0c1118);
      }
      a { color: var(--primary); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .wrap { max-width: 1100px; margin: 0 auto; }
      header { margin-bottom: 16px; }
      h1 { font-size: 28px; margin: 0 0 6px; }
      h2 { font-size: 18px; margin: 18px 0 8px; }
      p.lead { color: var(--muted); margin: 0 0 16px; }
      .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
      .grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 16px; }
      @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

      /* Diagram */
      .diagram { background: #0d1219; border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
      .legend { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; color: var(--muted); }
      .legend span { display: inline-flex; align-items: center; gap: 6px; }
      .tag { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }
      .t-ui { background: #2c3e50; }
      .t-api { background: #3b82f6; }
      .t-svc { background: #22c55e; }
      .t-repo { background: #a855f7; }
      .t-ext { background: #f59e0b; }
      .t-db { background: #ef4444; }
      .t-storage { background: #14b8a6; }

      .flow { display: grid; grid-template-columns: repeat(7, minmax(120px, 1fr)); gap: 6px; align-items: center; overflow-x: auto; padding-bottom: 8px; }
      .node { background: #121826; border: 1px solid var(--border); border-radius: 10px; padding: 10px; min-height: 76px; }
      .node h3 { margin: 0 0 6px; font-size: 13px; color: var(--muted); font-weight: 600; letter-spacing: .02em; text-transform: uppercase; }
      .node .k { color: #c7d2fe; font-size: 12px; }
      .node .small { color: var(--muted); font-size: 12px; }
      .arrow { text-align: center; color: var(--muted); font-size: 18px; }

      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      code { background: #10151f; border: 1px solid var(--border); padding: 2px 6px; border-radius: 8px; color: #c7e1ff; }
      pre { background: #0e1420; border: 1px solid var(--border); padding: 12px; border-radius: 12px; overflow: auto; }
      .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      @media (max-width: 900px) { .cols { grid-template-columns: 1fr; } }
      ul { margin: 8px 0 0 18px; }
      li { margin: 4px 0; }
      .note { color: var(--muted); }
      .status { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; }
      .ok { color: var(--ok); border-color: #1d3f2a; background: #0c1911; }
      .warn { color: var(--warn); border-color: #3e2d0a; background: #171207; }
      .err { color: var(--err); border-color: #441515; background: #160a0a; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Interior AI — Generation Flow Map</h1>
        <p class="lead">A visual, easy-to-understand walkthrough of how an image generation request moves through our API, services, Replicate, webhooks, storage, and back to the user.</p>
      </header>

      <section class="diagram">
        <div class="legend">
          <span><i class="tag t-ui"></i> UI (Client)</span>
          <span><i class="tag t-api"></i> API Route</span>
          <span><i class="tag t-svc"></i> Service</span>
          <span><i class="tag t-repo"></i> Repository</span>
          <span><i class="tag t-ext"></i> Replicate</span>
          <span><i class="tag t-storage"></i> Storage</span>
          <span><i class="tag t-db"></i> Database</span>
        </div>
        <div class="flow">
          <div class="node">
            <h3>UI</h3>
            <div class="k">POST /api/v1/generations</div>
            <div class="small">multipart form: mode, settings, input1/2</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <h3>API Route</h3>
            <div class="k">app/api/v1/generations/route.ts</div>
            <div class="small">Validate + auth → call service</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <h3>Service</h3>
            <div class="k">libs/services/generation.ts</div>
            <div class="small">in‑flight + quota + prompt build</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <h3>Uploads</h3>
            <div class="k">private/&lt;uid&gt;/inputs/*</div>
            <div class="small">Signed URLs for Replicate</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <h3>Replicate</h3>
            <div class="k">create prediction</div>
            <div class="small">webhook → /api/v1/webhooks/replicate</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <h3>Webhook</h3>
            <div class="k">handle + persist</div>
            <div class="small">store images → renders/*</div>
          </div>
          <div class="arrow">⟶</div>
          <div class="node">
            <h3>UI Poll</h3>
            <div class="k">GET /api/v1/generations/:id</div>
            <div class="small">returns variant URLs</div>
          </div>
        </div>
      </section>

      <div class="grid" style="margin-top:16px;">
        <section class="panel">
          <h2>Step‑By‑Step</h2>
          <ol>
            <li><b>Submit</b>: Client posts multipart form with <code>mode</code>, <code>prompt</code>, presets, <code>variants</code>, and files.</li>
            <li><b>Validate</b>: Route parses Zod schema, checks auth, builds <code>submission</code>, infers <code>baseUrl</code>.</li>
            <li><b>Business rules</b>: Service enforces one in‑flight per user, quota (monthly), basic moderation, and builds the final prompt.</li>
            <li><b>Upload</b>: Inputs go to <code>private/&lt;uid&gt;/inputs/&lt;uuid&gt;.&lt;ext&gt;</code>; service creates short‑lived signed URLs.</li>
            <li><b>Prediction</b>: Adapter maps our request to Replicate inputs (aspect ratio, quality, number_of_images, input_images, output_format=webp).</li>
            <li><b>Persist job</b>: <code>generation_jobs</code> row created, status <span class="status ok">starting</span>; debit recorded in <code>usage_ledger</code>.</li>
            <li><b>Webhook</b>: Replicate posts results; handler downloads each output, stores under <code>public/renders/&lt;renderId&gt;/&lt;idx&gt;.webp</code>, inserts <code>renders</code> + <code>render_variants</code>, marks job <span class="status ok">succeeded</span> or <span class="status err">failed</span>.</li>
            <li><b>Poll</b>: UI polls <code>GET /api/v1/generations/:id</code>; when succeeded, returns variant URLs for display and actions.</li>
          </ol>
        </section>

        <section class="panel">
          <h2>Guards & Statuses</h2>
          <ul>
            <li><b>One in‑flight</b>: rejects new submissions while a job is <span class="status warn">starting/processing</span>.</li>
            <li><b>Quota</b>: plan limits via <code>profiles.price_id</code> → <code>runtimeConfig.plans</code> → <code>usage_ledger</code>.</li>
            <li><b>Idempotency</b>: optional <code>idempotencyKey</code> dedupes duplicate submits.</li>
            <li><b>Moderation</b>: lightweight prompt/image checks to block obviously disallowed content.</li>
            <li><b>Polling</b>: non‑terminal jobs older than 5s are polled once server‑side to refresh status.</li>
          </ul>

          <h2 style="margin-top:14px;">Key Tables & Paths</h2>
          <ul>
            <li><code>generation_jobs</code>: { id, owner_id, prediction_id, status, error, created_at, completed_at, input*_path }</li>
            <li><code>renders</code>/<code>render_variants</code>: group and persist outputs; <code>image_path</code> is storage‑relative.</li>
            <li>Storage: inputs → <code>private/&lt;uid&gt;/inputs/*</code>; outputs → <code>public/renders/&lt;renderId&gt;/&lt;idx&gt;.webp</code></li>
          </ul>
        </section>
      </div>

      <section class="panel" style="margin-top:16px;">
        <h2>Data Shapes (Simplified)</h2>
        <div class="cols">
<pre>{
  // submission → service
  mode: 'redesign'|'staging'|'compose'|'imagine',
  prompt?: string,
  roomType?: string,
  style?: string,
  settings?: { aspectRatio?: '1:1'|'3:2'|'2:3', quality?: 'auto'|'low'|'medium'|'high', variants?: number },
  input1?: File, input2?: File,
  idempotencyKey?: string
}</pre>
<pre>{
  // adapter → replicate
  openai_api_key: string,
  prompt: string,
  input_images?: string[],
  aspect_ratio: '1:1'|'3:2'|'2:3',
  number_of_images: 1|2|3,
  output_format: 'webp',
  quality?: 'auto'|'low'|'medium'|'high',
  user_id?: string
}</pre>
        </div>
      </section>

      <section class="panel" style="margin-top:16px;">
        <h2>Where to Look (Code Map)</h2>
        <ul>
          <li><b>API</b>: <code>app/api/v1/generations/route.ts</code>, <code>app/api/v1/generations/[id]/route.ts</code></li>
          <li><b>Service</b>: <code>libs/services/generation.ts</code>, <code>libs/services/generation_webhooks.ts</code></li>
          <li><b>Adapter/Client</b>: <code>libs/services/external/replicateAdapter.ts</code>, <code>replicateClient.ts</code></li>
          <li><b>Repositories</b>: <code>libs/repositories/generation_jobs.ts</code>, <code>renders.ts</code>, <code>usage.ts</code></li>
          <li><b>Storage</b>: <code>libs/services/storage/uploads.ts</code>, <code>storage/assets.ts</code></li>
          <li><b>Migrations</b>: <code>migrations/phase2/005_*.sql</code>, <code>006_*.sql</code>, <code>009_*.sql</code></li>
        </ul>
        <p class="note">Open the companion page <a href="./replicate-principles.html">Replicate Predictions — First Principles</a> for a deeper dive into Replicate itself.</p>
      </section>

    </div>
  </body>
</html>

